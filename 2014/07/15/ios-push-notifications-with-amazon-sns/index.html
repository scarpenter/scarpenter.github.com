
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>iOS Push Notifications with Amazon SNS - Sean Carpenter</title>
  <meta name="author" content="Sean Carpenter">

  
  <meta name="description" content="Amazon SNS provides a cost-effective way to send push notifications to mobile devices. This is especially true for the relatively low push volume &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://blog.seancarpenter.net/2014/07/15/ios-push-notifications-with-amazon-sns/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Sean Carpenter" type="application/atom+xml">
  <meta name="msvalidate.01" content="2DF57F3ACCC667335B1C38AB138FA855" />
<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12873243-1']);
    _gaq.push(['_setDomainName', 'seancarpenter.net']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Sean Carpenter</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.seancarpenter.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">iOS Push Notifications With Amazon SNS</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-15T17:33:00-04:00" pubdate data-updated="true">Jul 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://aws.amazon.com/sns/?nc1=h_l2_as">Amazon SNS</a> provides a cost-effective way to send push notifications to mobile devices. This is especially true for the relatively low push volume generated by something like the Roku sleep timer in <a href="http://itunes.apple.com/us/app/romote/id488604877?ls=1&amp;mt=8&amp;at=10l5G3&amp;ct=blog">Romote</a>. Using SNS for mobile push is also supported well by the Ruby <a href="https://github.com/aws/aws-sdk-ruby">aws-sdk</a>.</p>

<!-- more -->


<p>To get started using SNS, you first need to create an app in SNS to represent your application. The <a href="http://docs.aws.amazon.com/sns/latest/dg/mobile-push-send-register.html">Amazon documentation</a> is pretty easy to follow - you will need the APNS certificate and private key from Apple for setting up push to iOS devices.</p>

<h3>Registering a Device</h3>

<p>Once you have an app created, you can start registering devices with it. This is accomplished using the <a href="http://docs.aws.amazon.com/sns/latest/api/API_CreatePlatformEndpoint.html">CreatePlatformEndpoint</a> API and requires the device token for the iOS device. I make the registration call from the <code>application:didRegisterforRemoteNotificationsWithDeviceToken:</code> callback in my application&#8217;s delegate.</p>

<h4>Aside</h4>

<p>I proxy all of the calls to SNS through a server that I run, so devices never communicate directly with SNS. This allows me to not expose any SNS credentials in my iOS apps as well as gives me the flexibility to change the communication with SNS (or remove SNS completely) without resubmitting the iOS apps.</p>

<p>Registering a device is easy using the Ruby aws-sdk:</p>

<figure class='code'><figcaption><span>Register a Device  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="no">AWS</span><span class="o">::</span><span class="no">SNS</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">client</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_platform_endpoint</span><span class="p">(</span>
</span><span class='line'>  <span class="n">platform_application_arn</span><span class="p">:</span> <span class="s2">&quot;application-id-from-sns&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="n">token</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:deviceToken</span><span class="o">]</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">endpoint_arn</span> <span class="o">=</span> <span class="n">response</span><span class="o">[</span><span class="ss">:endpoint_arn</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>endpoint_arn</code> can then be sent back to the device to use in future push notifications (or stored for later use at the server).</p>

<h3>Sending a Push Notification</h3>

<p>Once a device is registered, you can send direct push notifications to that device. This is done using the <a href="http://docs.aws.amazon.com/sns/latest/api/API_Publish.html">Publish</a> API. The <code>Publish</code> API supports sending a different message to each supported SNS transport as well as specifying a default message; when using device-specific mobile push notifications this isn&#8217;t necessary as each device will only be using a single transport (APNS or APNS_SANDBOX is the case of iOS).</p>

<p>SNS supports specifying all of the keys that Apple expects in a push notification using transport-specific messages. This requires setting the <code>MessageStructure</code> parameter of the <code>Publish</code> call to &#8220;json&#8221; and supplying a JSON formatted object in the <code>Message</code> parameter. One thing the documentation doesn&#8217;t make clear is that these need to be JSON-encoded strings and not raw JSON. An example will make this clearer:</p>

<figure class='code'><figcaption><span>Sending a Push  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;APNS&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;aps&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">&quot;content-available&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">},</span>
</span><span class='line'>    <span class="s2">&quot;other_data&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;some_data&quot;</span>
</span><span class='line'>  <span class="p">}</span><span class="o">.</span><span class="n">to_json</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;APNS_SANDBOX&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;aps&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">&quot;content-available&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">},</span>
</span><span class='line'>    <span class="s2">&quot;other_data&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;some_data&quot;</span>
</span><span class='line'>  <span class="p">}</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">push_parameters</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">target_arn</span><span class="p">:</span> <span class="s2">&quot;endpoint_arn_from_registration&quot;</span>
</span><span class='line'>  <span class="n">message_structure</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="n">message</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="no">AWS</span><span class="o">::</span><span class="no">SNS</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">client</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">push_parameters</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice the <code>to_json</code> calls on lines 5, 9, and 14. Each transport key needs to be a JSON string inside the <code>Message</code> parameter. Additionally, the <code>Message</code> parameter itself needs to be a JSON string. Getting this wrong (by having actual JSON instead of a JSON string) leads to SNS not being able parse the <code>Message</code> parameter and generates an error of &#8220;InvalidParameter: Invalid parameter: JSON must contain an entry for &#8216;default&#8217; or &#8216;APNS_SANDBOX&#8217;&#8221;.</p>

<p>The value of the <code>other_data</code> key is available in the <code>userInfo</code> dictionary provided to the <code>application:didReceiveRemoteNotification:</code> callback in your iOS application:</p>

<figure class='code'><figcaption><span>Handling the Notification  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didReceiveRemoteNotification:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">userInfo</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSString</span><span class="o">*</span> <span class="n">otherData</span> <span class="o">=</span> <span class="p">[</span><span class="n">userInfo</span> <span class="nl">objectForKey:</span><span class="s">@&quot;other_data&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Summary</h3>

<p>Using just a few straightforward calls, it&#8217;s possible to send push notifications to your iOS apps. SNS also supports other mobile platforms (including Google Cloud Messaging and Amazon Device Messaging) as well as broadcasting messages to subscribed devices (using topics) instead of targeting individual devices.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a rel="author" href="/about/">Sean Carpenter</a></span></span>

      








  


<time datetime="2014-07-15T17:33:00-04:00" pubdate data-updated="true">Jul 15<span>th</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2013/12/18/romote-now-with-a-sleep-timer/" title="Previous Post: Romote: Now with a Sleep Timer">&laquo; Romote: Now with a Sleep Timer</a>
      
      
        <a class="basic-alignment right" href="/2015/12/21/ro-to-sleep-a-new-roku-sleep-timer/" title="Next Post: Ro To Sleep - A New Roku Sleep Timer">Ro To Sleep - A New Roku Sleep Timer &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2015/12/21/ro-to-sleep-a-new-roku-sleep-timer/">Ro To Sleep - A New Roku Sleep Timer</a>
      </li>
    
      <li class="post">
        <a href="/2014/07/15/ios-push-notifications-with-amazon-sns/">iOS Push Notifications with Amazon SNS</a>
      </li>
    
      <li class="post">
        <a href="/2013/12/18/romote-now-with-a-sleep-timer/">Romote: Now with a Sleep Timer</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Sean Carpenter -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
